# float4

cudaé‡Œé¢ä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç±»å‹ï¼Œä¸‹é¢æ˜¯ç±»å‹çš„å®šä¹‰ï¼š

```cpp
struct __device_builtin__ __builtin_align__(16) float4
{
    float x, y, z, w;
};
```

åœ¨cppä¸­çš„è½¬æ¢æ–¹æ³•ç›´æ¥ä½¿ç”¨`reinterpret_cast<float4*>()`æ¥è½¬æ¢å³å¯ï¼Œä½†æ˜¯åŠ¡å¿…ä¿è¯åé¢è¦æœ‰4ä¸ªæµ®ç‚¹æ•°ï¼ä½¿ç”¨float4çš„æœ€å¤§çš„å¥½å¤„å°±æ˜¯
å¯ä»¥å¢åŠ å†…å­˜æ•ˆç‡ï¼Œå› ä¸ºä¸€æ¬¡æ€§è¯»å–å››ä¸ªæµ®ç‚¹æ•°è‚¯å®šæ¯”è¯»å››æ¬¡æµ®ç‚¹æ•°æ•ˆç‡è¦é«˜å¾ˆå¤šã€‚

---

# half

[CUDA ç¼–ç¨‹æŒ‡å—](https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html?highlight=half#bit-floating-point-textures)

CUDA æ•°ç»„æ”¯æŒçš„ 16 ä½æµ®ç‚¹æˆ–åŠæ ¼å¼ä¸ IEEE 754-2008 binary2 æ ¼å¼ç›¸åŒã€‚

å½“ç„¶çŸ¥é“ï¼Œ`half` å’Œ `half2` æ˜¯ CUDA ä¸­ç”¨äº **16-bit åŠç²¾åº¦æµ®ç‚¹æ•°ï¼ˆFP16ï¼‰** çš„æ•°æ®ç±»å‹ï¼Œå®ƒä»¬å¸¸ç”¨äº **æ·±åº¦å­¦ä¹ åŠ é€Ÿ** æˆ– **å†…å­˜å¸¦å®½å—é™åœºæ™¯**ã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†è§£é‡Šï¼š

---

## ğŸ§® 1. `half` æ˜¯ä»€ä¹ˆï¼Ÿ

`half` æ˜¯ CUDA ä¸­çš„ **16ä½ IEEE 754 åŠç²¾åº¦æµ®ç‚¹æ•°** ç±»å‹ï¼Œå…·æœ‰å¦‚ä¸‹ä½ç»“æ„ï¼š

| ç¬¦å·ä½ (sign) | æŒ‡æ•°ä½ (exponent, 5 bits) | å°¾æ•° (mantissa, 10 bits) |
| ---------- | ---------------------- | ---------------------- |
| 1 bit      | 5 bits                 | 10 bits                |

### ç‰¹ç‚¹ï¼š

* å ç”¨ 2 å­—èŠ‚ï¼ˆ16 bitï¼‰
* è¡¨ç¤ºèŒƒå›´è¿œå°äº `float`ï¼ˆ32-bitï¼‰ï¼Œç²¾åº¦ä¹Ÿè¾ƒä½
* é€‚ç”¨äºæ·±åº¦å­¦ä¹ ä¸­å¯¹ç²¾åº¦ä¸æ•æ„Ÿä½†å¯¹å¸¦å®½æˆ–å­˜å‚¨æ•æ„Ÿçš„åœºæ™¯

---

## ğŸ§Š 2. å¦‚ä½•ä½¿ç”¨ `half`ï¼Ÿ

éœ€è¦ `#include <cuda_fp16.h>`ï¼Œç„¶åå°±å¯ä»¥å£°æ˜å’Œæ“ä½œ `half` ç±»å‹ï¼š

```cpp
#include <cuda_fp16.h>

__global__ void kernel(half *a, half *b, half *c) {
    int i = threadIdx.x;
    c[i] = __hadd(a[i], b[i]);  // ä½¿ç”¨ CUDA çš„ half åŠ æ³•æŒ‡ä»¤
}
```

### å¸¸è§çš„ half è¿ç®—å‡½æ•°ï¼ˆä»¥ `__hadd` ä¸ºä¾‹ï¼‰ï¼š

| å‡½æ•°                    | è¯´æ˜             |
| --------------------- | -------------- |
| `__hadd`              | half åŠ æ³•        |
| `__hsub`              | half å‡æ³•        |
| `__hmul`              | half ä¹˜æ³•        |
| `__hdiv`              | half é™¤æ³•        |
| `__float2half(float)` | float è½¬æ¢ä¸º half |
| `__half2float(half)`  | half è½¬æ¢ä¸º float |

---

## ğŸ§± 3. `half2` æ˜¯ä»€ä¹ˆï¼Ÿ

`half2` æ˜¯ CUDA ä¸­çš„ä¸€ä¸ª **å‘é‡ç±»å‹**ï¼Œè¡¨ç¤º **ä¸¤ä¸ª half ç»„æˆçš„ç»“æ„**ï¼Œä¸»è¦ç”¨äº **SIMD é£æ ¼çš„å¹¶è¡Œè®¡ç®—**ã€‚

```cpp
typedef struct __align__(4) {
    half x;
    half y;
} half2;
```

### ä½¿ç”¨ç¤ºä¾‹ï¼š

```cpp
__global__ void kernel(half2 *a, half2 *b, half2 *c) {
    int i = threadIdx.x;
    c[i] = __hadd2(a[i], b[i]);  // SIMD ä¸¤ä¸ª half ç›¸åŠ 
}
```

### å¸¸è§ half2 è¿ç®—å‡½æ•°ï¼š

| å‡½æ•°                          | è¯´æ˜                    |
| --------------------------- | --------------------- |
| `__hadd2`                   | ä¸¤ä¸ª `half2` å‘é‡é€ä½åŠ æ³•     |
| `__hmul2`                   | ä¸¤ä¸ª `half2` å‘é‡é€ä½ä¹˜æ³•     |
| `__half2float2(half2)`      | è½¬æ¢ä¸ºä¸¤ä¸ª float           |
| `__floats2half2_rn(f1, f2)` | ä¸¤ä¸ª float è½¬ half2ï¼Œå››èˆäº”å…¥ |

---

## ğŸ’¡ 4. æ³¨æ„äº‹é¡¹

* ä¸æ˜¯æ‰€æœ‰çš„ GPU éƒ½å¯¹ `half` å’Œ `half2` æä¾›ç¡¬ä»¶åŠ é€Ÿï¼Œè¦æ³¨æ„ä½ çš„ GPU æ¶æ„æ˜¯å¦æ”¯æŒ FP16ï¼ˆä¾‹å¦‚ Voltaã€Turingã€Ampere ç­‰ï¼‰
* `half2` åªèƒ½åœ¨æ”¯æŒå‘é‡åŒ–çš„æ¶æ„ä¸­ä½¿ç”¨å…¶åŠ é€ŸæŒ‡ä»¤
* CPU ç«¯å¹¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ `half` è¿ç®—ï¼Œéœ€è¦é€šè¿‡ `__half` ç±»å‹ä»¥åŠæ‰‹åŠ¨è½¬æ¢

## 5. å¤ä¹ ä¸€ä¸‹æ•°æ®ç²¾åº¦

![img.png](assets/img.png)

---
